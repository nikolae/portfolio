<!doctype html>
<html class="no-js" lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>UniFi VLANs and AirPlay</title>

    <link rel="stylesheet" type="text/css" href="https://nickaroneseno.com/assets/css/styles_feeling_responsive.css">

  

	<script src="https://nickaroneseno.com/assets/js/modernizr.min.js"></script>

	<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script>
	<script>
		WebFont.load({
			google: {
				families: [ 'Lato:400,700,400italic:latin', 'Volkhov::latin' ]
			}
		});
	</script>

	<noscript>
		<link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic%7CVolkhov' rel='stylesheet' type='text/css'>
	</noscript>


	<!-- Search Engine Optimization -->
	<meta name="description" content="UniFi likes to do things differently. Here&#39;s how to use properly segmented networks, VLANs and AirPlay together.">
	
	
	
	
	
	<link rel="canonical" href="https://nickaroneseno.com/network/vlan/UniFi-VLAN-&-IoT-AirPlay/">


	<!-- Facebook Open Graph -->
	<meta property="og:title" content="UniFi VLANs and AirPlay">
	<meta property="og:description" content="UniFi likes to do things differently. Here&#39;s how to use properly segmented networks, VLANs and AirPlay together.">
	<meta property="og:url" content="https://nickaroneseno.com/network/vlan/UniFi-VLAN-&-IoT-AirPlay/">
	<meta property="og:locale" content="en_EN">
	<meta property="og:type" content="website">
	<meta property="og:site_name" content="Nick Aroneseno: A technical journey">
	<meta property="og:image" content="http://nickaroneseno.com/assets/images/headers/network.jpg">
	


	

	<link type="text/plain" rel="author" href="https://nickaroneseno.com/humans.txt">

	

	

	<link rel="icon" sizes="32x32" href="https://nickaroneseno.com/assets/img/favicon-32x32.png">

	<link rel="icon" sizes="192x192" href="https://nickaroneseno.com/assets/img/touch-icon-192x192.png">

	<link rel="apple-touch-icon-precomposed" sizes="180x180" href="https://nickaroneseno.com/assets/img/apple-touch-icon-180x180-precomposed.png">

	<link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://nickaroneseno.com/assets/img/apple-touch-icon-152x152-precomposed.png">

	<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://nickaroneseno.com/assets/img/apple-touch-icon-144x144-precomposed.png">

	<link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://nickaroneseno.com/assets/img/apple-touch-icon-120x120-precomposed.png">

	<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://nickaroneseno.com/assets/img/apple-touch-icon-114x114-precomposed.png">

	
	<link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://nickaroneseno.com/assets/img/apple-touch-icon-76x76-precomposed.png">

	<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://nickaroneseno.com/assets/img/apple-touch-icon-72x72-precomposed.png">

	<link rel="apple-touch-icon-precomposed" href="https://nickaroneseno.com/assets/img/apple-touch-icon-precomposed.png">	

	<meta name="msapplication-TileImage" content="https://nickaroneseno.com/assets/img/msapplication_tileimage.png">

	<meta name="msapplication-TileColor" content="#fabb00">


	

	


</head>
<body id="top-of-page" class="page-fullwidth">
	
	
<div id="navigation" class="sticky">
  <nav class="top-bar" role="navigation" data-topbar data-options="scrolltop: false">
    <ul class="title-area">
      <li class="name">
      <h1 class="hide-for-large-up"><a href="https://nickaroneseno.com" class="icon-tree"> Nick Aroneseno: A technical journey</a></h1>
    </li>
       <!-- Remove the class "menu-icon" to get rid of menu icon. Take out "Menu" to just have icon alone -->
      <li class="toggle-topbar toggle-topbar-click menu-icon"><a><span>Nav</span></a></li>
    </ul>
    <section class="top-bar-section">

      <ul class="left">
        

              

          
          

            
            
              <li><a  href="https://nickaroneseno.com/">Home</a></li>
              <li class="divider"></li>

            
            
          
        

              

          
          

            
            

              <li class="has-dropdown">
                <a  href="https://nickaroneseno.com/blog/">Posts</a>

                  <ul class="dropdown">
                    

                      

                      <li><a  href="https://nickaroneseno.com/blog/archive/">Archives</a></li>
                    
                  </ul>

              </li>
              <li class="divider"></li>
            
          
        

              

          
          
        

              

          
          
        

              

          
          
        

              

          
          
        
        
      </ul>
      
      

      <ul class="right">
        

              



          
          
        

              



          
          
        

              



          
          
            
            
              <li class="divider"></li>
              <li><a  href="https://nickaroneseno.com/tags/software">Software</a></li>

            
            
          
        

              



          
          
            
            
              <li class="divider"></li>
              <li><a  href="https://nickaroneseno.com/tags/hardware">Hardware</a></li>

            
            
          
        

              



          
          
            
            

              <li class="divider"></li>
              <li class="has-dropdown">
                <a  href="https://nickaroneseno.com/about">About</a>

                  <ul class="dropdown">
                    

                      

                      <li><a  href="https://nickaroneseno.com/changelog/">Changes</a></li>
                    

                      

                      <li><a  href="https://nickaroneseno.com/contact/">Contact</a></li>
                    
                  </ul>

              </li>
            
          
        

              



          
          
            
            
              <li class="divider"></li>
              <li><a  href="https://nickaroneseno.com/search/">Search</a></li>

            
            
          
        
        
      </ul>
     
    </section>
  </nav>
</div><!-- /#navigation -->

	

	




	
<div class="row t30">
	<div class="small-12 columns">
		<img src="http://nickaroneseno.com/assets/images/headers/network.jpg" width="970" alt="UniFi VLANs and AirPlay">
		
		<p class="text-right caption">
			<a href="https://stock.adobe.com/">Image: Adobe Stock</a>
		</p>
		
	</div><!-- /.small-12.columns -->
</div><!-- /.row -->



<div class="row t30">
	<div class="medium-12 columns">
		<article>
			<header>
				
				<h1>UniFi VLANs and AirPlay</h1>
			</header>

			
			<p class="teaser">
				UniFi likes to do things differently. Here's how to use properly segmented networks, VLANs and AirPlay together.
			</p>
			

			<h2 id="objective">Objective</h2>

<p>Create an internal network (LAN) that is separate from IoT devices, but still have limited communication back and forth such that media protocols such as multicast and AirPlay work. In this configuration, IoT devices are allowed to talk to each other freely and to access the internet, but only selectively to LAN (AirPlay being the main example in this demo). To verify after setup, you can connect a PC to the IoT network and try accessing devices on LAN (use <code class="language-plaintext highlighter-rouge">ping</code> or trying to access a shared volume). As bonus points, to make a further restricted setup, we will change IoT to a Guest Network; this prevents IoT devices from talking to each other at all. As IoT devices typically need to peer connections, this is not recommended without site-specific research.</p>

<div class="panel radius">
  <p id="toc"><strong>Table of Contents</strong></p>
<ul id="markdown-toc">
  <li><a href="#objective" id="markdown-toc-objective">Objective</a></li>
  <li><a href="#test-setup" id="markdown-toc-test-setup">Test setup</a></li>
  <li><a href="#create-networks" id="markdown-toc-create-networks">Create Networks</a>    <ul>
      <li><a href="#lan" id="markdown-toc-lan">LAN</a></li>
      <li><a href="#iot" id="markdown-toc-iot">IoT</a></li>
      <li><a href="#enable-multicast-support" id="markdown-toc-enable-multicast-support">Enable Multicast support</a></li>
      <li><a href="#in-the-wifi-network-for-lan-verify-these-settings" id="markdown-toc-in-the-wifi-network-for-lan-verify-these-settings">In the WiFi network for LAN, verify these settings:</a></li>
    </ul>
  </li>
  <li><a href="#firewall" id="markdown-toc-firewall">Firewall</a>    <ul>
      <li><a href="#create-firewall-groups" id="markdown-toc-create-firewall-groups">Create Firewall Groups</a></li>
      <li><a href="#now-that-the-two-groups-are-made-start-making-these-rules" id="markdown-toc-now-that-the-two-groups-are-made-start-making-these-rules">Now that the two groups are made, start making these rules:</a></li>
      <li><a href="#remainder-of-rules" id="markdown-toc-remainder-of-rules">Remainder of rules</a></li>
      <li><a href="#ssh" id="markdown-toc-ssh">SSH</a></li>
      <li><a href="#testing" id="markdown-toc-testing">Testing</a></li>
    </ul>
  </li>
  <li><a href="#references" id="markdown-toc-references">References</a></li>
</ul>

</div>

<h2 id="test-setup">Test setup</h2>

<ul>
  <li>PC with iTunes (on LAN)</li>
  <li>Phone with Apple Music (on LAN WiFi)</li>
  <li>UniFi controller running the network application</li>
  <li>Managed switch</li>
  <li>A media enabled music player (Iâ€™m using a Yamaha RX-A1060 receiver) (on wired IoT).</li>
</ul>

<h2 id="create-networks">Create Networks</h2>
<p>Create the main and IoT networks.
<img src="/assets/images/guides/vlan1.jpg" alt="VLAN1" /></p>

<h3 id="lan">LAN</h3>
<p><img src="/assets/images/guides/vlan2.jpg" alt="VLAN2" /></p>

<h3 id="iot">IoT</h3>
<p><img src="/assets/images/guides/vlan3.jpg" alt="VLAN3" /></p>
<blockquote>
  <p>Note: See the VLAN ID - make sure this is the same for this network throughout the process. IGMP Snooping seems to have no effect. I tested both, but then left it enabled.</p>
</blockquote>

<h3 id="enable-multicast-support">Enable Multicast support</h3>
<p><img src="/assets/images/guides/vlan4.jpg" alt="VLAN4" /></p>

<h3 id="in-the-wifi-network-for-lan-verify-these-settings">In the WiFi network for LAN, verify these settings:</h3>
<p><img src="/assets/images/guides/vlan5.jpg" alt="VLAN5" /></p>

<h2 id="firewall">Firewall</h2>

<h3 id="create-firewall-groups">Create Firewall Groups</h3>
<p><img src="/assets/images/guides/vlan6.jpg" alt="VLAN6" /></p>
<blockquote>
  <p>Note: the ports are highly specific to your environment. Not every port was objectively tested. Recommend investigation with Wireshark and is left as an exercise to the reader. For reference: <a href="https://community.ui.com/questions/Is-there-a-recommended-way-to-get-Apple-AirPlay-to-work-across-VLANs/80ccb2e8-ce73-4a37-9cc7-1530d4cdc870">UI.com</a></p>
</blockquote>

<p><img src="/assets/images/guides/vlan7.jpg" alt="VLAN7" /></p>

<p><img src="/assets/images/guides/vlan8.jpg" alt="VLAN8" /></p>

<p>The previous two groups allow for quick changing of settings. The port group will be setup to allow IoT devices to broadcast back new sessions to the controlling devices on LAN. This configuration is not intuitive, as one typically thinks allowing ports open from LAN to IoT. However, the protocol works in such a way that mDNS allows you to initially see the IoT devices from LAN (and their IPs) and try to establish an initial connection. After that initial connection, the ports from IoT to LAN as new sessions are then required to complete the circuit, as it were.</p>

<p>The second group of IP address ranges are to be customized for your specific network. These will be used as an end rule to block anything that doesnâ€™t match the allow rules. It should be composed of any networks in your setup you would like to secure from IoT (typically all).</p>

<h3 id="now-that-the-two-groups-are-made-start-making-these-rules">Now that the two groups are made, start making these rules:</h3>
<p><img src="/assets/images/guides/vlan9.jpg" alt="VLAN9" /></p>

<p>LAN In, in Ubiquitiâ€™s parlance, is the first instance in which packets enter your LAN. Backwards from industry, as best I can tell, but so be it.</p>

<h3 id="remainder-of-rules">Remainder of rules</h3>
<p>This says that LAN can access anything and is used as a launching off point.
<img src="/assets/images/guides/vlan10.jpg" alt="VLAN10" /></p>

<p>Allow LAN to IoT. This is essentially duplicate, but in case you lock down LAN as a whole, this will keep the setup working.
<img src="/assets/images/guides/vlan11.jpg" alt="VLAN11" /></p>

<p>Allow IoT to LAN established/related. This says that after a device in LAN initially asks an IoT device for a connection, we will allow that initial talk-back from IoT to LAN, but only if the originating source was a device from LAN. Note that new is not checked. Also note the groups used for ease of setup and configuration later.
<img src="/assets/images/guides/vlan12.jpg" alt="VLAN12" /></p>

<p>Allow IoT port groups. This is similar to the previous rule but different in a critical way: we are specifically allowing new connections to go from IoT to LAN, but only on specific ports, and only on specific protocols (no SSH, for instance). Update: Changing to UDP only seems to also work for my specific configuration and would be more preferable - the less protocols allowed the better. You will have to experiment on your own network as you add new IoT devices and modify as appropriate.
<img src="/assets/images/guides/vlan13.jpg" alt="VLAN13" /></p>

<p>Finally, block anything else that doesnâ€™t explicitly match the above criteria. 
<img src="/assets/images/guides/vlan14.jpg" alt="VLAN14" /></p>

<p>Apply the above settings, noting the order of the rules.</p>

<h3 id="ssh">SSH</h3>
<p>Settings are found under Site. Once the USG is done provisioning, ssh into it and clear connections.
<a href="https://help.ui.com/hc/en-us/articles/115010254227-UniFi-USG-Firewall-How-to-Disable-InterVLAN-Routing">UI.com</a></p>

<p><code class="language-plaintext highlighter-rouge">clear connection-tracking</code></p>

<p><img src="/assets/images/guides/vlan15.jpg" alt="VLAN15" /></p>

<p><img src="/assets/images/guides/vlan16.jpg" alt="VLAN16" /></p>

<h3 id="testing">Testing</h3>

<p>Now that the devices are setup and provisioned (you waited, right?), time to test. In my network, the receiver came online on the IoT network as expected, and I will test using my PC.</p>

<p><img src="/assets/images/guides/vlan17.jpg" alt="VLAN17" /></p>

<p><img src="/assets/images/guides/vlan18.jpg" alt="VLAN18" /></p>

<p>In this setup to test back access, I can assign the PC into the IoT network and play to the Yamaha. I also cannot access other devices, controller or ping other LAN-based devices. Moving back to the LAN network, I can still cast to the receiver as shown above. My phone on LAN WiFi also has no trouble.</p>

<p>That should be it. Close/reopen apps / reconnect to wifi, etc. This setup has been repeatable and testable for myself and some guinea pigs I verified this with. Reminder that all of the allowed ports are not explicitly tested and are more of a catch-all based on the AirPlay protocol.</p>

<h2 id="references">References</h2>
<ul>
  <li><a href="https://www.reddit.com/r/Ubiquiti/comments/p483ua/airplay_and_vlans/">https://www.reddit.com/r/Ubiquiti/comments/p483ua/airplay_and_vlans/</a></li>
  <li><a href="https://help.ui.com/hc/en-us/articles/115010254227-UniFi-USG-Firewall-How-to-Disable-InterVLAN-Routing">https://help.ui.com/hc/en-us/articles/115010254227-UniFi-USG-Firewall-How-to-Disable-InterVLAN-Routing</a></li>
  <li><a href="https://community.ui.com/questions/Is-there-a-recommended-way-to-get-Apple-AirPlay-to-work-across-VLANs/80ccb2e8-ce73-4a37-9cc7-1530d4cdc870">https://community.ui.com/questions/Is-there-a-recommended-way-to-get-Apple-AirPlay-to-work-across-VLANs/80ccb2e8-ce73-4a37-9cc7-1530d4cdc870</a></li>
  <li><a href="https://community.ui.com/questions/Airplay-across-VLAN-How-to-do/0362cb7f-f38c-43ba-b10e-c2e5cc9dbe16?page=1">https://community.ui.com/questions/Airplay-across-VLAN-How-to-do/0362cb7f-f38c-43ba-b10e-c2e5cc9dbe16?page=1</a></li>
  <li><a href="https://community.ui.com/questions/Solved-AirPlay-across-walled-off-VLANs/7435c86b-e857-4ebf-bdca-bfd8d67b6647">https://community.ui.com/questions/Solved-AirPlay-across-walled-off-VLANs/7435c86b-e857-4ebf-bdca-bfd8d67b6647</a></li>
</ul>


		</article>
	</div><!-- /.medium-12.columns -->
</div><!-- /.row -->




	
	    <div id="up-to-top" class="row">
      <div class="small-12 columns" style="text-align: right;">
        <a class="iconfont" href="#top-of-page">&#xf108;</a>
      </div><!-- /.small-12.columns -->
    </div><!-- /.row -->


    <footer id="footer-content" class="bg-grau">
      <div id="footer">
        <div class="row">
          <div class="medium-6 large-5 columns">
            <h5 class="shadow-black">About This Site</h5>

            <p class="shadow-black">
              A personal <em>how did I do this that one time</em> archive, portfolio, and personal web presence.
              <a href="https://nickaroneseno.com/info/">More â€º</a>
            </p>
          </div><!-- /.large-6.columns -->


          <div class="small-6 medium-3 large-3 large-offset-1 columns">
            
              
                <h5 class="shadow-black">Services</h5>
              
            
              
            
              
            
              
            
              
            

              <ul class="no-bullet shadow-black">
              
                
                  <li >
                    <a href="https://nickaroneseno.com"  title=""></a>
                  </li>
              
                
                  <li >
                    <a href="https://nickaroneseno.com/contact/"  title="Contact">Contact</a>
                  </li>
              
                
                  <li >
                    <a href="https://nickaroneseno.com/feed.xml"  title="Subscribe to RSS Feed">RSS</a>
                  </li>
              
                
                  <li >
                    <a href="https://nickaroneseno.com/atom.xml"  title="Subscribe to Atom Feed">Atom</a>
                  </li>
              
                
                  <li >
                    <a href="https://nickaroneseno.com/sitemap.xml"  title="Sitemap for Google Webmaster Tools">sitemap.xml</a>
                  </li>
              
              </ul>
          </div><!-- /.large-4.columns -->


          <div class="small-6 medium-3 large-3 columns">
            
              
                <h5 class="shadow-black">Acknowledgements</h5>
              
            
              
            
              
            

            <ul class="no-bullet shadow-black">
            
              
                <li >
                  <a href="https://nickaroneseno.com"  title=""></a>
                </li>
            
              
                <li class="network-entypo" >
                  <a href="https://jekyllrb.com/" target="_blank"  title="Jekyll">Jekyll Community</a>
                </li>
            
              
                <li class="services-newsletter" >
                  <a href="https://phlow.github.io/" target="_blank"  title="Feeling Responsive">Theme derived from Feeling Responsive by Phlow</a>
                </li>
            
            </ul>
          </div><!-- /.large-3.columns -->
        </div><!-- /.row -->

      </div><!-- /#footer -->


      <div id="subfooter">
        <nav class="row">
          <section id="subfooter-left" class="small-12 medium-6 columns credits">
            <p>A personal <em>how did I do this that one time</em> archive, portfolio, and personal web presence. Â© 2023 Nick Aroneseno</p>
          </section>

          <section id="subfooter-right" class="small-12 medium-6 columns">
            <ul class="inline-list social-icons">
            
              <li><a href="https://github.com/nikolae" target="_blank" class="icon-github" title="Never Commit, Never Surrender"></a></li>
            
              <li><a href="https://www.linkedin.com/in/naroneseno" target="_blank" class="icon-linkedin" title="Connect with me"></a></li>
            
            </ul>
          </section>
        </nav>
      </div><!-- /#subfooter -->
    </footer>

	

	


<script src="https://nickaroneseno.com/assets/js/javascript.min.js"></script>












</body>
</html>

